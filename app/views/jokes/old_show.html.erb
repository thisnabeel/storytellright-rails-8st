<style>

	.acts {
		margin: 10px 0;
	}
	.act {
		padding: 10px;
	}

	.act h1 {
		text-align: center;
		font-family: 'VT323', monospace;
		color: #e74c3c;
	}

	.message-form .fr-view p {
		font-family: 'VT323', monospace !important;
		font-size: 24px;
	}

	.acts i {
		font-size: 20px;
		cursor: pointer;
	}

	.acts .fleshed-out-act {
		color: #27ae60;
	}

	.fleshed-out {
		display: none;
	}

	.froalize .fr-view {
		/*background-color: #fff;*/
		color: #9e7806;
	}

	.joke-wrapper {
		padding: 100px;
	}
	.joke-title {
		padding: 30px;
	}

	.necessary-form li {
		list-style: none;
    	background: #fff;
    	padding: 10px;
    	margin: 10px;
	}

	.necessary-form>ul>li {
		position: relative;
	}

	.characters li {
		border: 6px solid #E8E8E8;
	}

	.characters .character-name input {
		background-color: #ffffff;
    	color: #007bff;
    	font-weight: bold;
	}

	.connection {
		padding: 14px 0;
	}

	.characters {
		display: none;
	}
	
	#characters-list-opener, .characters-list-opener {
	    position: fixed;
	    left: 0;
	    top: 0;
	    height: 100%;
	    background: #fdfcfc;
	    padding: 10px;
	    min-width: 10px;
	    
	    -webkit-box-shadow: 10px 10px 70px -16px rgba(0,0,0,0.56);
		-moz-box-shadow: 10px 10px 70px -16px rgba(0,0,0,0.56);
		box-shadow: 10px 10px 70px -16px rgba(0,0,0,0.56);
	}

	#notes-opener, .notes-opener {
	    position: fixed;
	    right: 0;
	    top: 0;
	    height: 100%;
	    background: #a5fffb !important;
	    padding: 10px;
	    min-width: 10px;
	    
	    -webkit-box-shadow: 10px 10px 70px -16px rgba(0,0,0,0.56);
		-moz-box-shadow: 10px 10px 70px -16px rgba(0,0,0,0.56);
		box-shadow: 10px 10px 70px -16px rgba(0,0,0,0.56);
	}

	#notes a {
		color: #92eaff;
	}

	#notes {
		display: none;
	    position: fixed;
	    right: 0;
	    top: 0;
	    height: 100%;
	    padding: 30px;
	    background: #2e2222;
    	color: #fff;
	    min-width: 225px;
   		max-width: 225px;
		-webkit-box-shadow: -10px 10px 17px -16px rgba(0,0,0,0.38);
		-moz-box-shadow: -10px 10px 17px -16px rgba(0,0,0,0.38);
		box-shadow: -10px 10px 17px -16px rgba(0,0,0,0.38);
	}

	#characters-list {
		display: none;
	    position: fixed;
	    left: 0;
	    top: 0;
	    height: 100%;
	    padding: 30px;
	    background: #f7f5f4;
	    min-width: 225px;
   		max-width: 225px;
		-webkit-box-shadow: 10px 10px 17px -16px rgba(0,0,0,0.38);
		-moz-box-shadow: 10px 10px 17px -16px rgba(0,0,0,0.38);
		box-shadow: 10px 10px 17px -16px rgba(0,0,0,0.38);
	}

	#characters-list li {
		list-style: none;
		padding: 6px;
		background-color: #FEFEFE;
		margin: 6px 0;
		border-radius: 10px;
		font-family: 'VT323', monospace !important;
		font-size: 22px;
	}

	.boolean-toggle {
		position: relative;
    	text-align: right;
	}
	
	.color-nav {
		/*display: inline;*/
	}
	.color-select {
		display: inline-block;
	    height: 10px;
	    width: 50px;
	    margin: 0px;
	    border-radius: 3px;
	}
	
	.color-select.villian {
		border: 1px solid #ff4757;
	}
	.color-select.villian.active,
	#characters-list .villian {
		background: #ff4757;
		color: #fff;
	}

	.color-select.clone,  {
		border: 1px solid #2ed573;
	}
	.color-select.clone.active {
		background: #2ed573;
	}

	.color-select.support {
		border: 1px solid #70a1ff;
	}
	.color-select.support.active {
		background: #70a1ff;
	}

	.color-select.alternative,
	#characters-list .alternative
	 {
		border: 1px solid #f9ca24;
	}

	.color-select.alternative.active,
	#characters-list .alternative {
		background: #f9ca24;
	}
	
	.color-blue .fr-view {
		color: #0669c1 !important;
	}


/*	.characters-count-badge {
		height: 10px;
		width: 10px;
		position: absolute;
		top: 0px;
		right: -10px;
		color: #9b59b6;
	}*/

	.mini-input {
		max-width: 200px;
		display: inline-block;
		position: relative;
		right: 0;
	}

	.extra-details {
		display: none;
	}

	.inputs {
		position: relative;
		max-width: 210px;
		margin: 0 auto;
	}

	.toggle-extra {
		position: absolute;
		right: -20px;
		top: 20px;
		font-size: 22px;
	}

	article.part {
		padding: 20px;
	}

	#part-1 {
		border: 20px solid #7bed9f;
	}

	#part-2 {
		border: 20px solid #ff6b81;
	}

	#part-3 {
		border: 20px solid #a29bfe;
		background-color: #fff;
	}

	#part-4 {
		border: 20px solid #3742fa;
		background-color: #fff;
	}

	.armature, .punchline {
		max-width: 55px;
	}

	.promise {
		max-width: 25px;
	}

	.bomb {
		max-width: 75px;
	}

	.armature-descendants {
		list-style: none;
	}

	.armature-descendants li {
	    display: inline-block;
	    width: 20px;
	    height: 20px;
	    background-color: transparent;
	    border: 2px solid #e84393;
	    border-radius: 100%;
	}

	.selected {
	    margin-top: 20px;
	    line-height: 50px;
	}

	.selected li {
		list-style: none;
	    display: inline-block;
	    padding: 14px;
	    background: #fff;
	    border-radius: 15px;
	    margin: 4px;
	    position: relative;
	}

	.selected .remove-item {
		position: absolute;
		top: 0px;
		left: 0px;
		color: #ccc;
	}

	.selected .remove-item:hover {
		color: #000;
	}

	.modal-dialog .modal-title {
		font-size: 34px;
		color: #5f27cd;
	}

	.modal-dialog ul {
		margin: 20px;
	}

	.modal-dialog {
	    max-width: 690px;
	    margin: 1.75rem auto;
	}

	.modal-content {
		padding: 3rem;
	}

	#part-3 .act-1.scenes-list li:not(:last-child),
	#part-3 .act-1.skeleton-list li:not(:last-child) {
		background-color: #00a8ff;
		color: #fff;
	}

	#part-3 .act-1.scenes-list li:last-child,
	#part-3 .act-1.skeleton-list li:last-child {
		/*border: 3px dashed #ed143d;*/
		background-color: #B53471;
		color: #fff;
	}

	#part-3 .act-3.scenes-list li:first-child,
	#part-3 .act-3.skeleton-list li:first-child {
	    background-color: #ed143d ;
	    color: #fff;
	}
	
	#part-3 .act-3.scenes-list li:nth-child(2),
	#part-3 .act-3.skeleton-list li:nth-child(2) {
	    background-color: #fff24f;
	    color: #000000;
	    margin-top: -10px;
    	position: relative;
    	top: -10px;
    	left: 10px;
    	border: 4px dashed #ff67af;
	}

	#part-3 .act-3.scenes-list li:last-child,
	#part-3 .act-3.skeleton-list li:last-child {
		background-color: #068733;
		color: #fff;
	}

	.scenes-list, 
	.skeleton-list {
		list-style: none;
	}

	.scenes-list li,
	.skeleton-list li {
		padding: 20px;
		-webkit-box-shadow: 0px 5px 14px -6px rgba(0,0,0,0.50);
		-moz-box-shadow: 0px 5px 14px -6px rgba(0,0,0,0.50);
		box-shadow: 0px 5px 14px -6px rgba(0,0,0,0.50);
		position: relative;
		margin: 10px 0;
	}

	.the-end, .scene-pic {
		max-width: 90px;
    	margin: 0 auto;
    	display: block;
	}

	.scenes-list .remove-item {
		position: absolute;
		top: 0;
		left: -5px;
	}

	.remove-item {
		color: #f1f1f1;
	}

	.remove-item:hover {
		color: #000;
	}

	@media (min-width: 576px) {
		.modal-dialog {
		    max-width: 690px;
		    margin: 1.75rem auto;
		}
	}

	.final-showdown {
		position: absolute;
    	top: 40px;
    	z-index: 9;
    	right: -20px;
	}

	.seatbelt {
	    max-width: 125px;
	    bottom: -25px;
	    border-radius: 10px;
	    z-index: 999;
	    /*background: #bfa000;*/
	    /*filter: invert(100%);*/
	    /* right: 2.5em; */
	    /* margin: 0 auto; */
	    /* text-align: center; */
		position: absolute;
		margin-left: auto;
		margin-right: auto;
		left: 0;
		right: 0;
		/*padding: 10px;*/
	}

	.promise-click {
	    max-width: 45px;
	    position: absolute;
	    right: -25px;
	    bottom: 10px;
	}

	/**/
	.little-boxes-train li {
		display: inline-block;
	    padding: 17px;
	    border: 2px solid #aee8ff;
	    margin: 10px;
	    border-radius: 20px;
	}

	.little-boxes-train li:hover {
		border: 2px solid #3cc8ff;
	}

</style>

<div class="joke-wrapper">
	<div class="title-form">
		<h1 class="text-center joke-title froalize">

			<textarea>
				<%= @joke.title %>
			</textarea>
			
			<div class="inputs">
				
				<input type="text" class="form-control year-input mini-input" value="<%= @joke.year %>">
				<i class="fa fa-plus toggle-extra"></i>
				<div class="extra-details">
					<input type="text" class="form-control tags-input mini-input" value="<%= @joke.tags %>" placeholder="Tags..."><br>
					<input type="text" class="form-control writer-input mini-input" value="<%= @joke.writer %>" placeholder="Writer...">
					<input type="text" class="form-control link-input mini-input" value="<%= @joke.link %>" placeholder="Link...">
				</div>
			</div>
		</h1>
	</div>
	
	<section class="boolean-toggle">
		<input type="checkbox" id="status" data-group-cls="btn-group-lg" data-off-title="Unready" data-on-title="Ready">
	</section>
	<br>
	
	<article class="part" id="part-1">
		
		<p>1. What is the <img src="<%= asset_path('armature.png') %>" alt="" class="armature"> of this joke? <i class="fa fa-question-circle"></i> </p>
		<div class="message-form froalize save-this" data-save-code="armature">
			<textarea>
				<%= @joke.joke_details["armature"].html_safe if @joke.joke_details.present?  %>
			</textarea>

			
		</div>
		

	</article>

	<article class="part joke-structures" id="part-2">
		<select name="" id="">
			<% JokeStructure.all.each do |js| %>
				<option value="<%= js.id %>">
					<%= js.title %>
				</option>
			<% end %>
		</select>
		<i class="fa fa-eye joke-structure-preview"></i>
		<i class="fa fa-plus"></i>

		<ul class="joke-structures-list clean-a little-boxes-train">
		</ul>
	</article>

	<article class="part joke-triggers" id="part-3">
		<select name="" id="">
			<% JokeTrigger.all.each do |js| %>
				<option value="<%= js.id %>">
					<%= js.title %>
				</option>
			<% end %>
		</select>
		<i class="fa fa-eye joke-trigger-preview little-boxes-train"></i>
		<i class="fa fa-plus"></i>

		<ul class="joke-triggers-list clean-a little-boxes-train">
		</ul>
	</article>

	<article class="part" id="film-watch">
	</article>

	<article class="part" id="part-pre-4">
	</article>

	<article class="part" id="part-4">
		<h3>Final:</h3>
	</article>
</div>

<!-- Characters List Opener -->
<div id="characters-list-opener" class="characters-list-opener">
</div>
<div id="characters-list">
	<div id="characters-list-opener" class="characters-list-opener">
	
	</div>
	<p><img src="<%= asset_path('puzzle.png') %>" alt="" class="punchline"></p>
	<hr>
	<ul>
		
	</ul>
</div>


<%= render "negative_traits/modal" %>
<%= render "positive_traits/modal" %>

<%= render "jokes/watch" %>


<script>

$(".acts i").on("click", function(){
	$(this).parent().toggleClass("fleshed-out-act")
	displayAct($(this).parent())
})

function displayAct(act){
	if (act.hasClass("fleshed-out-act")){
		act.closest(".act").find(".bare-bones").slideUp()
		act.closest(".act").find(".fleshed-out").slideDown()
	} else {
		act.closest(".act").find(".bare-bones").slideDown()
		act.closest(".act").find(".fleshed-out").slideUp()
	}
}

$('.collapse-clicker').click( function(e) {
    $('.collapse').collapse('hide');
});


makeFroala()
function makeFroala(){

 $(".froalize textarea, textarea.froalize").froalaEditor({
 	key: froalaKey,
	toolbarInline: true,
	charCounterCount: false,
	toolbarButtons: ['bold', 'italic', 'underline', 'strikeThrough', 'color', 'emoticons', '-', 'paragraphFormat', 'align', 'formatOL', 'formatUL', 'indent', 'outdent', '-', 'insertImage', 'insertLink', 'insertFile', 'insertVideo', 'undo', 'redo'],
   saveInterval: 500
  })
  .on('froalaEditor.save.before', function (e, editor) {
    // Before save request is made.
    saveJoke()
    save()
  })
  .on('froalaEditor.save.after', function (e, editor, response) {
    // After successfully save request.
  })
  .on('froalaEditor.save.error', function (e, editor, error) {
    // Do something here.
  });
}

function details(){
	
	list = {}

	$(".save-this").each(function(){
		code = $(this).attr("data-save-code")
		list[code] = $(this).find(".fr-view").html()
	})

	list["necessary-list"] = []
	$(".necessary-form > ul > li").each(function(){
		view = $(this).find(".element").find(".fr-view").html()

		if ($(this).find(".characters").find("li").length) {
			characters = []
			$(this).find(".characters").find("li").each(function(){

				if ($(this).find(".color-nav .active").length) {
					color = $(this).find(".color-nav .active").attr("data-color")
				} else {
					color = null
				}

				console.log(color)

				characters.push({
					name: $(this).find(".name input").val(),
					connection: $(this).find(".connection").find(".fr-view").html(),
					color: color
				})
			})

			list["necessary-list"].push({
				element: view,
				characters: characters
			})
		} else {
			list["necessary-list"].push({
				element: view
			})
		}

	})

	list["negative_traits"] = []
	$(".nt-list").find("li").each(function(){
		list["negative_traits"].push($(this).attr("data-id"))
	})

	list["positive_traits"] = []
	$(".pt-list").find("li").each(function(){
		list["positive_traits"].push($(this).attr("data-id"))
	})
	
	// Skeleton
	list["act-1-skeleton"] = []
	$(".act-1.skeleton-list").find("li").each(function(){
		list["act-1-skeleton"].push($(this).find(".fr-view").html())
	})

	list["act-2-skeleton"] = []
	$(".act-2.skeleton-list").find("li").each(function(){
		list["act-2-skeleton"].push($(this).find(".fr-view").html())
	})

	list["act-3-skeleton"] = []
	$(".act-3.skeleton-list").find("li").each(function(){
		list["act-3-skeleton"].push($(this).find(".fr-view").html())
	})

	// Scenes
	list["act-1-scenes"] = []
	$(".act-1.scenes-list").find("li").each(function(){
		list["act-1-scenes"].push({
			timestamp: $(this).find(".timestamp").val(),
			body: $(this).find(".fr-view").html(),
		})
	})

	list["act-2-scenes"] = []
	$(".act-2.scenes-list").find("li").each(function(){
		list["act-2-scenes"].push({
			timestamp: $(this).find(".timestamp").val(),
			body: $(this).find(".fr-view").html(),
		})
	})

	list["act-3-scenes"] = []
	$(".act-3.scenes-list").find("li").each(function(){
		list["act-3-scenes"].push({
			timestamp: $(this).find(".timestamp").val(),
			body: $(this).find(".fr-view").html(),
		})
	})

	list["notes"] = $("#notes").find(".fr-view").html()

	list["transition"] = $(".transition").val()
	

	list["act-1-highlight"] = {
		description: $(".act-1-highlight").find(".description").val(),
		timestamp: $(".act-1-highlight").find(".timestamp").val()
	}

	list["act-3-highlight"] = {
		description: $(".act-3-highlight").find(".description").val(),
		timestamp: $(".act-3-highlight").find(".timestamp").val()
	}

	console.log(list)

	return list
}

$(".transition").on("change", function(){
	saveJoke()
    save()
})

var options = {
    callback: function (value) { 
    	saveJoke()
    	save()
    },
    wait: 750,
    highlight: true,
    allowSubmit: false,
    captureLength: 2
}

$(".year-input").typeWatch( options );
$(".tags-input").typeWatch( options );
$(".writer-input").typeWatch( options );
$(".link-input").typeWatch( options );
$(".timestamp").typeWatch( options );
$("#part-pre-4 input").typeWatch( options );



function saveJoke(){
	// alert("hi")
   original = parseInt( $(".boolean-toggle .active").attr("is") )
   $.ajax({
       type: "PUT",
       dataType: "json",
       url: '/jokes/<%= @joke.id %>',
       contentType: 'application/json',
       data: JSON.stringify({ 
       	title: $(".title-form").find(".fr-view").text(),
       	joke_details: details(),
       	original: original,
       	year: $(".year-input").val(),
       	tags: $(".tags-input").val(),
       	writer: $(".writer-input").val(),
       	link: $(".link-input").val(),
          _method:'post' 
       }),
       success: function(res){
         // console.log(res)
         console.log("Saved!")
       }
   })	

   // alertify.success('Saved!');
}

$(".delete-draft").on("click", function(){
	id = $(this).attr("data-id")
   $.ajax({
       type: "DELETE",
       dataType: "json",
       url: '/joke_recipes/' + id,
       contentType: 'application/json',
       data: JSON.stringify({ 
          _method:'post' 
       }),
       success: function(res){
         console.log(res)
       }
   })
   $(this).closest(".list-group-item").remove()
})

$("body").on("click", ".remove-item", function(){
	$(this).closest("li").remove()
	countCharacters()
	saveJoke()
})

$(".add-n-item").on("click", function(){
	$(".necessary-form>ul").append(`<li>
				<div class="row">
					<div class="col-lg-10 element">
						<textarea class="froalize">
						</textarea>
					</div>
					<div class="col-lg-2 spans-nav">
						<span class="remove-item">
							<i class="fa fa-times"></i>
						</span>
						<span class="handle">
							<i class="fa fa-bars"></i>
						</span>
						<span>
							<i class="fa fa-users" aria-hidden="true"></i>
						</span>
						<span class="toggle-characters btn">
							0
						</span>
					</div>
				</div>
				<ul class="characters" id="`+$(".n-list>li").length+`-ch-list">
					<hr>
					<span class="btn btn-primary add-character">
						Add Character
					</span>
				</ul>
			</li>`)
	makeFroala()
	makeSorted("n-list")
	countCharacters()
})

function makeSorted(id){
	var el = document.getElementById(id);
	// var sortable = Sortable.create(list);
	var sortable = Sortable.create(el, {
		handle: ".handle",
		onUpdate: function(/**Event*/evt) {
			evt.newIndex // most likely why this event is used is to get the dragging element's current index
			// same properties as onEnd
			saveJoke()
		}
	});
	makeCharacters()

}



$("body").on("click", ".add-character", function(){
	ul = $(this).closest("li").find(".characters")
	ul.append(`<li>
		<div class="row">
			<div class="col-lg-11">
				<div class="color-nav">
					<span class="color-select villian" data-color="villian"></span>
					<span class="color-select alternative" data-color="alternative"></span>
				</div>
				<div class="name character-name">
					<input class="form-control" type='text' placeholder="Enter Character Name...">
				</div>
				<div class="connection">
					<textarea class="froalize"></textarea>
				</div>
			</div>
			<div class="col-lg-1 spans-nav">
				<span class="remove-item">
					<i class="fa fa-times"></i>
				</span>
				<span>
					<i class="fa fa-bars handle"></i>
				</span>
			</div>
		</div>
	</li>`)
	makeFroala()
	makeSorted($(this).closest(".characters").attr("id"))
	countCharacters()
})

$("body").on("click", ".fa-users", function(){
	$(this).closest("li").find(".characters").toggle()
})

$("body").on("click", ".toggle-characters", function(){
	$(this).closest("li").find(".characters").toggle()
})





$(".characters-list-opener").on("click", function(){
	$("#characters-list").toggle("slide");
})

$(".notes-opener").on("click", function(){
	$("#notes").toggle("slide");
})


	$(':checkbox').checkboxpicker({
	  offLabel: 'Study',
	  onLabel: 'Original'
	}
	).on('change', function(el) {
		console.log($(this).attr('checked'))
	});

	<% if @joke.original == true %>
		$('#status').prop('checked', true);
	<% end %>

	$("body").on('click', ".boolean-toggle .btn-group .btn", function(){
		saveJoke()
	})

	$("body").on("click", ".color-select", function(){
		$(this).toggleClass("active")
		saveJoke()
		makeCharacters()
	})

	$(".toggle-extra").on('click', function(){
		$(".extra-details").toggle()
	})


	$(".add-t").on("click", function(){
		val = $(this).closest("div").find("select").val()
		ul = $(this).closest("div").find(".selected")
		name = $(this).closest("div").find("select option:selected" ).html();
		ul.append("<li data-id='"+val+"'><i class='fa fa-times remove-item'></i>"+name+"</li>")
		saveJoke()
	})

	$("body").on("click", ".selected li", function(){
		
		modal = $("#" + $(this).closest("ul").attr('data-trigger'))
		link = $(this).closest("ul").attr('data-link')

		$.getJSON( "/"+link+"/" + $(this).attr("data-id"), function( data ) {
		  console.log(data)
		  $.each(data["details"], function(index, item){
			console.log(index)
			modal.find(".modal-title").html(data["title"])
			modal.find(".deet[data-title='"+index+"']").find("p").html(item)
		  })

		  modal.show()
		  modal.modal("show")
		});
	})

	$(".scenes-list .body, .skeleton-list .body, #notepad, .catalyst textarea").froalaEditor({
		key: froalaKey,
	toolbarInline: true,
	charCounterCount: false,
	toolbarButtons: ['bold', 'italic', 'underline', 'strikeThrough', 'color', 'emoticons', '-', 'paragraphFormat', 'align', 'formatOL', 'formatUL', 'indent', 'outdent', '-', 'insertImage', 'insertLink', 'insertFile', 'insertVideo', 'undo', 'redo'],
   saveInterval: 500
  })
  .on('froalaEditor.save.before', function (e, editor) {
    // Before save request is made.
    saveJoke()
    save()
  })
  .on('froalaEditor.save.after', function (e, editor, response) {
    // After successfully save request.
  })
  .on('froalaEditor.save.error', function (e, editor, error) {
    // Do something here.
  });


  // 
  $(".add-to-list").on("click", function(){
  	$(this).closest("div").find("ul").append(`
  		<li>
			<span class="remove">
				<i class="fa fa-times"></i>
  			</span>
  			<span class="play-timestamp">
				<i class="fa fa-play"></i>
  			</span>
			<input type="text" class="form-control timestamp">
			<article class="body">
			</article>
  		</li>
  	`)
  })

  $("#part-4 .remove").on("click", function(){
  	$(this).closest("li").remove()
	saveJoke()
    save()
  })

</script>

<%= render "joke_structures/modal" %>
<%= render "joke_triggers/modal" %>